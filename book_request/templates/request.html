{% extends 'base.html' %}

{% block content %}
<p hidden id="nama-User">{{user}}</p>
<div id="add-request">
    
<!-- Code block starts -->
<dh-component>
            
    <div class="py-12 bg-gray-700 transition duration-150 ease-in-out z-10 absolute top-0 right-0 bottom-0 left-0" id="modal" aria-hidden="true" hidden>
        <div role="alert" class="container mx-auto w-11/12 md:w-2/3 max-w-lg">
            <div class="relative py-8 px-5 md:px-10 bg-white shadow-md rounded border border-gray-400">
                <div class="w-full flex justify-start text-gray-600 mb-3">
                    <svg  xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-wallet" width="52" height="52" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" />
                        <path d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
                        <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
                    </svg>
                    <h1 class="text-gray-800 font-lg font-bold tracking-normal leading-tight mb-4">Request a Book</h1>
                </div>
                <form method="post" id="request-form">
                    {% csrf_token %}
                    <label for="title" class="text-gray-800 text-sm font-bold leading-tight tracking-normal">Title</label>
                    <input name="title" type="text" id="title" class="mb-5 mt-2 text-gray-600 focus:outline-none focus:border focus:border-indigo-700 font-normal w-full h-10 flex items-center pl-3 text-sm border-gray-300 rounded border" placeholder="Title" required></input>
                    <label for="author" class="text-gray-800 text-sm font-bold leading-tight tracking-normal">Author</label>
                    <input name="author" type="text" id="author" class="mb-5 mt-2 text-gray-600 focus:outline-none focus:border focus:border-indigo-700 font-normal w-full h-10 flex items-center pl-3 text-sm border-gray-300 rounded border" placeholder="Author" required></input>
                    <label for="year" class="text-gray-800 text-sm font-bold leading-tight tracking-normal">Year</label>
                    <input name="year" type="number" id="year" class="mb-5 mt-2 text-gray-600 focus:outline-none focus:border focus:border-indigo-700 font-normal w-full h-10 flex items-center pl-3 text-sm border-gray-300 rounded border" placeholder="Year" required></input>
                    <label for="language" class="text-gray-800 text-sm font-bold leading-tight tracking-normal">Language</label>
                    <input name="language" type="text" id="language" class="mb-5 mt-2 text-gray-600 focus:outline-none focus:border focus:border-indigo-700 font-normal w-full h-10 flex items-center pl-3 text-sm border-gray-300 rounded border" placeholder="Language" required></input>
                    <label for="subjects" class="text-gray-800 text-sm font-bold leading-tight tracking-normal">Subjects</label>
                    <br>
                    <input id="showGenre" for="subjects" class="text-gray-800 text-sm font-bold leading-tight tracking-normal" disabled></input>
                    <select id="subject" name="subject" class="block w-full mt-1 form-multiselect" multiple="true">
                        <option value="" disabled>Select an option</option>
                        {% for genre in subjects %}
                            <option value="{{ genre }}" required>{{ genre }}</option>
                        {% endfor %}
                    </select>
                    <button id="addGenre" type="button">Add Genre</button>
                    <br>

                    <div class="flex items-center justify-start w-full">
                        <button class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 transition duration-150 ease-in-out hover:bg-indigo-600 bg-indigo-700 rounded text-white px-8 py-2 text-sm" onclick="request()">Submit</button>
                        <button class="focus:outline-none focus:ring-2 focus:ring-offset-2  focus:ring-gray-400 ml-3 bg-gray-100 transition duration-150 text-gray-600 ease-in-out hover:border-gray-400 hover:bg-gray-300 border rounded px-8 py-2 text-sm" onclick="modalHandler()">Cancel</button>
                    </div>
                </form>
                <button class="cursor-pointer absolute top-0 right-0 mt-4 mr-5 text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out rounded focus:ring-2 focus:outline-none focus:ring-gray-600" onclick="modalHandler()" aria-label="close modal" role="button">
                    <svg  xmlns="http://www.w3.org/2000/svg"  class="icon icon-tabler icon-tabler-x" width="20" height="20" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" />
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div class="w-full flex justify-center py-12" id="button">
        <button class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 mx-auto transition duration-150 ease-in-out hover:bg-indigo-600 bg-indigo-700 rounded text-white px-4 sm:px-8 py-2 text-xs sm:text-sm" onclick="modalHandler(true)">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
                <line x1="25" y1="10" x2="25" y2="40" stroke="white" stroke-width="3"/>
                <line x1="10" y1="25" x2="40" y2="25" stroke="white" stroke-width="3"/>
            </svg>            
        </button>
    </div>
    <script>
        let modal = document.getElementById("modal");
        function modalHandler(val) {
            if (val) {
                fadeIn(modal);
            } else {
                fadeOut(modal);
            }
        }
        function fadeOut(el) {
            el.style.opacity = 1;
            (function fade() {
                if ((el.style.opacity -= 0.1) < 0) {
                    el.style.display = "none";
                } else {
                    requestAnimationFrame(fade);
                }
            })();
        }
        function fadeIn(el, display) {
            el.style.opacity = 0;
            el.style.display = display || "flex";
            (function fade() {
                let val = parseFloat(el.style.opacity);
                if (!((val += 0.2) > 1)) {
                    el.style.opacity = val;
                    requestAnimationFrame(fade);
                }
            })();
        }
        var select = document.getElementById('subject');
        select.addEventListener('mousedown', function(e){
            e.preventDefault();
            var scroll = this.scrollTop;
            e.target.selected = !e.target.selected;
            setTimeout(function(){select.scrollTop = scroll;}, 0);
            this.focus();
        });
        select.addEventListener('mousemove', function(e){
            e.preventDefault();
        });
        const selected = document.getElementById('subject');
        const button = document.getElementById('addGenre')
        button.addEventListener('click', () => {
            console.log("aaaaaaaaaaaaaaa")
        const selectedOptions = [];

        for (const option of selected.options) {
            if (option.selected) {
            selectedOptions.push(option.value);
            }
        }
        let showGenre = document.getElementById('showGenre')
        showGenre.value = selectedOptions.join(', ')
        console.log(selectedOptions)
        })        
    </script>
    
</dh-component>
</div>
<label for="sortby">Sort by:</label>
<select id="sortby" name="sortby" onchange="sortBooks()">
    <option value="title">Title</option>
    <option value="author">Author</option>
    <option value="year">Year</option>
    <option value="language">Language</option>
    <option value="subjects">Subjects</option>
    <option value="date_requested">Date Requested</option>
</select>
<label for="sortorder">Sort order:</label>
<button id="sortorder" name="sortorder" onclick="orderSort()"></button>
<h1>My Requests: </h1>
<table>
<thead id="header-user">
    <tr>
        <th>Title</th>
        <th>Author</th>
        <th>Year</th>
        <th>Language</th>
        <th>Subjects</th>
        <th>Date Requested</th>
    </tr>
</thead>
<tbody id="user_request">
    <tr>
        {% for book in all_books %}
        {% endfor %}
    </tr>
</tbody>
</table>
<p id="no-request-user"></p>
<h1>All Requests: </h1>
<table>
    <thead id="header-all">
        <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Year</th>
            <th>Language</th>
            <th>Subjects</th>
            <th onclick="sortHeader('date_requested')">Date Requested</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="all_requests">
        <tr>
            {% for book in all_books %}
            {% endfor %}
        </tr>
    </tbody>
</table>
<p id="no-request-all"></p>
<script>
    async function getUserRequest() {
        return fetch("{% url 'book_request:get_request_json_user' %}").then((res) => res.json());
    }
    async function getRequests() {
        return fetch("{% url 'book_request:get_requests_json' %}").then((res) => res.json());
    }
    async function getSubjects() {
        return fetch("{% url 'book_request:get_subjects_json' %}").then((res) => res.json());
    }
    async function request() {
        fetch("{% url 'book_request:requesting' %}", {
            method: "POST",
            body: new FormData(document.getElementById('request-form'))
            
        })
        .then(refreshUserRequest).then(refreshAllRequests).then(console.log("Request added"))
            .catch((error) => console.error("Error adding product: ", error));

        document.getElementById("request-form").reset();
        return false;
    }
    async function refreshUserRequest() {
        const products = await getUserRequest();
        let htmlString = "";
        if (products.length == 0) {
            // document.getElementById("header-user").innerHTML = "";
            htmlString = "<p>You haven't requested anything.</p>";
            document.getElementById("no-request-user").innerHTML = htmlString;
            document.getElementById("user_request").innerHTML = "";
        }
        else {
            const urlParams = new URLSearchParams(window.location.search);
            let sortBy = urlParams.get("sortby");
            let sortOrder = urlParams.get("sortorder");
            if (sortBy == null) {
                sortBy = "title";
            }
            if (sortOrder == null) {
                sortOrder = "asc";
            }
            products.sort((a, b) => {
                if (a[sortBy] < b[sortBy]) {
                    return sortOrder == "asc" ? -1 : 1;
                }
                if (a[sortBy] > b[sortBy]) {
                    return sortOrder == "asc" ? 1 : -1;
                }
                return 0;
            });
            products.forEach((item) => {
                let subjects = "";
                    for (let i = 0; i < item.subjects.length; i++) {
                        subjects += item.subjects[i].charAt(0).toUpperCase() + item.subjects[i].slice(1);
                        subjects += i == item.subjects.length - 1 ? "" : ", ";
                    }
                htmlString += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.author}</td>
                        <td>${item.year}</td>
                        <td>${item.language}</td>
                        <td>${subjects}</td>
                        <td>${item.date_requested}</td>
                        <td><button onclick=editBook(${item.id})>Edit</button></td>
                        <td><button onclick=deleteBook(${item.id})>Cancel</button></td>
                    </tr>
                `;

            })
            document.getElementById("user_request").innerHTML = htmlString;
        }
    }
    async function refreshAllRequests() {
        urlParams = new URLSearchParams(window.location.search)
        document.getElementById("sortorder").innerHTML = urlParams.get("sortorder") == "asc" ? "Ascending" : "Descending";
        const sortby = urlParams.get("sortby");
        if (sortby) {
            document.getElementById("sortby").value = sortby;
        }
        // document.getElementById("sortby").setAttribute(name=document.getElementById("sortby").getAttribute(name),urlParams.get("sortby"))
        let namaUser = document.getElementById("nama-User").innerHTML;
        const products = await getRequests();
        console.log(products)
        let htmlString = "";
        if (products.length == 0) {
            // document.getElementById("header-all").innerHTML = "";
            htmlString = "<p>No book requests at this time.</p>";
            document.getElementById("no-request-all").innerHTML = htmlString;
            document.getElementById("all_requests").innerHTML ="";
        }
        else{
            products.sort((a, b) => {
                if (a[sortBy] < b[sortBy]) {
                    return sortOrder == "asc" ? -1 : 1;
                }
                if (a[sortBy] > b[sortBy]) {
                    return sortOrder == "asc" ? 1 : -1;
                }
                return 0;
            });
            products.forEach((item) => {
                console.log(item.member)
                let subjects = "";
                for (let i = 0; i < item.subjects.length; i++) {
                    subjects += item.subjects[i].charAt(0).toUpperCase() + item.subjects[i].slice(1);
                    subjects += i == item.subjects.length - 1 ? "" : ", ";
                }
                if (item.member == namaUser) {
                    console.log(item)
                    htmlString += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.author}</td>
                        <td>${item.year}</td>
                        <td>${item.language}</td>
                        <td>${subjects}</td>
                        <td>${item.date_requested}</td>
                        <td><button onclick=editBook(${item.id})>Edit</button></td>
                        <td><button onclick=deleteBook(${item.id})>Cancel</button></td>
                    </tr>
                `;
                }
                else{
                    htmlString += `
                        <tr>
                            <td>${item.title}</td>
                            <td>${item.author}</td>
                            <td>${item.year}</td>
                            <td>${item.language}</td>
                            <td>${subjects}</td>
                            <td>${item.date_requested}</td>
                        </tr>
                    `;
                }

            })
            document.getElementById("all_requests").innerHTML = htmlString;
        }

    }
    function editBook(id) {
        const formData = new FormData()
        formData.append("id", id)
        fetch("{% url 'book_request:edit_book' %}",{
            method: "POST",
            body: formData
        }).then(refreshUserRequest).then(refreshAllRequests)

        return false
    }
    function deleteBook(id) {
        const formData = new FormData()
        formData.append("id", id)
        fetch("{% url 'book_request:delete_book' %}",{
            method: "POST",
            body: formData
        }).then(refreshUserRequest).then(refreshAllRequests)

        return false
    }
    function sortBooks(){
        sortBy = document.getElementById("sortby").value
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set("sortby", sortBy);
        window.location.search = urlParams.toString();
    }
    function orderSort(){
        const urlParams = new URLSearchParams(window.location.search);
        let sortOrder = urlParams.get("sortorder");
        document.getElementById("sortorder").innerHTML = sortOrder;
        if (sortOrder == "asc") {
            sortOrder = "desc";
        } else if(sortOrder == "desc"){
            sortOrder = "asc";
        }
        urlParams.set("sortorder", sortOrder);
        document.getElementById("sortorder").innerHTML = sortOrder == "asc" ? "Ascending" : "Descending";
        window.location.search = urlParams.toString();
    }
    window.onload = function() {
        refreshUserRequest();
        refreshAllRequests();
    }
</script>

{% endblock %}


